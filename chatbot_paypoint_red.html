<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuiKub Ai Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0; padding: 0; 
            background-color: #f0f4f8; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        
        .chat-container {
            display: flex; flex-direction: column; height: 100%; 
            background: white;
            max-width: 100%;
            margin: 0 auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.05);
        }
        
        /* Header Theme */
        .chat-header {
            background: linear-gradient(120deg, #3b82f6, #06b6d4); 
            color: white;
            padding: 14px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 10px -2px rgba(59, 130, 246, 0.3);
            flex-shrink: 0;
            z-index: 20;
        }

        .chat-messages {
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1.5px, transparent 1.5px);
            background-size: 24px 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px;
            scroll-behavior: smooth;
        }

        .chat-input-area {
            padding: 16px; 
            border-top: 1px solid #f1f5f9; 
            background: white;
            display: flex; 
            gap: 12px; 
            position: relative;
            flex-shrink: 0;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }

        .chat-input {
            flex: 1; 
            padding: 12px 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 50px;
            outline: none; 
            font-size: 0.95em; 
            transition: all 0.3s ease;
            background-color: #f8fafc;
            color: #334155;
        }
        .chat-input:focus { 
            border-color: #3b82f6; 
            background-color: white; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border: none; 
            width: 46px; 
            height: 46px;
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }
        .chat-send-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35); }
        .chat-send-btn:active { transform: scale(0.95); }

        /* Bubbles */
        .msg { 
            max-width: 85%; 
            padding: 14px 18px; 
            border-radius: 20px; 
            font-size: 0.95em; 
            line-height: 1.6; 
            word-wrap: break-word; 
            position: relative;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.bot { 
            background: white; 
            color: #334155; 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
            border: 1px solid #f1f5f9; 
        }
        
        .msg.user { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
        }
        
        .msg.error { 
            border: 1px solid #fecaca; 
            background: #fef2f2; 
            color: #b91c1c; 
            align-self: center;
            font-size: 0.85em;
            text-align: center;
        }

        .msg img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .msg img:hover { transform: scale(1.02); }

        /* Chips */
        .suggestions { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            padding: 12px 20px; 
            background: white; 
            border-bottom: 1px solid #f8fafc; 
            white-space: nowrap;
            flex-shrink: 0;
            scrollbar-width: none; 
        }
        .suggestions::-webkit-scrollbar { display: none; }
        
        .chip {
            background: #f0f9ff; 
            color: #0369a1; 
            padding: 8px 16px; 
            border-radius: 25px;
            font-size: 0.85em; 
            cursor: pointer; 
            border: 1px solid #e0f2fe; 
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Prompt', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chip:hover { 
            background: #0ea5e9; 
            color: white; 
            border-color: #0ea5e9; 
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2);
        }

        /* Typing Dots */
        .typing-container {
            display: flex; align-items: center; gap: 4px; padding: 4px 0;
        }
        .typing-dot { 
            width: 6px; height: 6px; background: #94a3b8; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Status Dot */
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;
            position: absolute; bottom: 0; right: 0;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
        .bg-loading { background-color: #fbbf24; }
        .bg-online { background-color: #4ade80; box-shadow: 0 0 8px rgba(74, 222, 128, 0.6); }
        
        /* Footer & Social */
        .footer {
            background-color: #f8fafc;
            padding: 8px 0;
            border-top: 1px solid #e2e8f0;
        }
        .social-links {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin-bottom: 4px;
        }
        .social-link {
            color: #94a3b8;
            font-size: 16px;
            transition: all 0.2s;
            text-decoration: none;
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%; background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .social-link:hover { transform: translateY(-2px); }
        .social-link.youtube:hover { color: #ef4444; }
        .social-link.line:hover { color: #06c755; }
        .social-link.facebook:hover { color: #1877f2; }

    </style>
</head>
<body>

    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-inner relative">
                    <!-- Icon ‡∏™‡∏≤‡∏ß‡∏™‡∏ß‡∏¢ -->
                    <i class="fa-solid fa-user-astronaut text-xl"></i>
                    <div id="db-status" class="status-dot bg-loading" title="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠..."></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg font-['Prompt'] tracking-wide">TuiKub Ai Assistant</h3>
                    <p class="text-[11px] opacity-90 font-light" id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...</p>
                </div>
            </div>
            <button onclick="window.parent.postMessage('closeChat', '*')" class="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">
                <i class="fa-solid fa-chevron-down text-lg"></i>
            </button>
        </div>

        <!-- Chips -->
        <div class="suggestions" id="suggestion-box">
            <span class="chip" onclick="quickAsk('‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏±‡∏á‡πÑ‡∏á')"><i class="fa-solid fa-magnifying-glass"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏</span>
            <span class="chip" onclick="quickAsk('‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')"><i class="fa-solid fa-hand-holding-dollar"></i> ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span>
            <span class="chip" onclick="quickAsk('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•')"><i class="fa-solid fa-map-location-dot"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•</span>
            <span class="chip" onclick="quickAsk('‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö')"><i class="fa-solid fa-comments"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages">
            <div class="msg bot">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏≤! <b>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô TuiKub (‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö)</b> ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡πà‡∏∞ üë©‚Äçüíºüíñ<br>
                ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå Paypoint ‡∏ó‡∏±‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠‡∏à‡πâ‡∏≤!
            </div>
        </div>

        <!-- Input -->
        <div class="chat-input-area">
            <input type="text" id="userInput" class="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞..." autocomplete="off" onkeypress="handleKeyPress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane text-lg"></i>
            </button>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="social-links">
                <a href="https://www.youtube.com/channel/UC0IEG_tOt1Hrj4FXDbkZN-A" target="_blank" class="social-link youtube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
                <a href="https://www.facebook.com/papacking" target="_blank" class="social-link facebook" title="Facebook"><i class="fa-brands fa-facebook"></i></a>
                <a href="https://lin.ee/khaW3QI" target="_blank" class="social-link line" title="Line"><i class="fa-brands fa-line"></i></a>
            </div>
            <div class="text-[10px] text-slate-400 text-center select-none font-['Prompt']">
                Powered by TuiKub Ai Assistant | Created by @pratya chatyachatmontree
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SHEET_ID = '13YE50RWDXik5YhrIqB6naWRxfwDFtFVFbtqs-2bH0Hc'; 
        const N8N_WEBHOOK_URL = "https://n8n.srv1265116.hstgr.cloud/webhook/chat"; 

        // --- DATA (Friendly Female Tone - Fallback) ---
        // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const STATIC_DATA = [
            // Contact Info
            { keywords: ["‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", "‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö", "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"], answer: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ **‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏** ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£ **099-218-8853** ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üôè" },
            
            // Tracking - Update link
            { keywords: ["‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç", "‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏", "‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡πÑ‡∏´‡∏ô", "‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"], answer: "‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤ üëá", url: "https://tuikub.github.io/tracking/tracking.html" },
            
            // Price - Update link
            { keywords: ["‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏£‡∏≤‡∏Ñ‡∏≤"], answer: "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá", url: "https://tuikub.github.io/tracking/price.html" },

            // Remote Area - Update link
            { keywords: ["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏≤‡∏∞"], answer: "‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá", url: "https://tuikub.github.io/tracking/remote.html" },

            // Franchise - Update link
            { keywords: ["‡∏™‡∏ô‡πÉ‡∏à", "‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå", "paypoint", "‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô", "‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà"], answer: "‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá", url: "https://tuikub.github.io/tracking/franchise.html" },

            // General greeting & Credit
            { keywords: ["‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ", "‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏î‡∏µ‡∏Ñ‡πà‡∏∞", "‡∏ó‡∏±‡∏Å"], answer: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏≤! üôè ‡∏ô‡πâ‡∏≠‡∏á TuiKub ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏• ‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à‡∏à‡πâ‡∏≤" },
            { keywords: ["‡πÉ‡∏Ñ‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤", "pratya"], answer: "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏ô‡∏â‡∏•‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì **Pratya Chatyachatmontree** ‡∏™‡∏∏‡∏î‡∏´‡∏•‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ üòé" },

            // Common issues
            { keywords: ["‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô", "‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠", "‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"], answer: "‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏û‡∏µ‡πà‡πÜ ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏ñ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡πâ‡∏≤" }
        ];

        let knowledgeBase = [...STATIC_DATA]; 
        let isDbLoaded = true; 

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchSheetData(); 
        });

        // --- Fetch Sheet ---
        async function fetchSheetData() {
            const statusDot = document.getElementById('db-status');
            const statusText = document.getElementById('status-text');
            try {
                // Fetch CSV from Sheet (Col A, B, C)
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                
                const csvText = await response.text();
                parseCSV(csvText); 
                
                statusDot.className = "status-dot bg-online";
                statusDot.title = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å Google Sheet)";
                statusText.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡πà‡∏∞ (Online)";
            } catch (error) {
                console.warn("Using Local Backup Data:", error);
                statusDot.className = "status-dot bg-loading"; 
                statusDot.title = "‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏£‡∏≠‡∏á (Google Sheet ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)";
                statusText.innerText = "‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏£‡∏≠‡∏á";
            }
        }

        // --- CSV Parser (Merge Mode) ---
        function parseCSV(text) {
            const newKnowledge = []; 
            const rows = text.split('\n');
            
            rows.forEach((row) => {
                if (!row.trim()) return;
                // Simple CSV split logic
                const cols = [];
                let current = '';
                let inQuote = false;
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { cols.push(current); current = ''; } 
                    else current += char;
                }
                cols.push(current);

                // Col 0 = Keywords, Col 1 = Answer, Col 2 = URL
                if (cols.length >= 2) {
                    const cleanKey = cols[0] ? cols[0].trim().replace(/^"|"$/g, '').replace(/""/g, '"').toLowerCase() : "";
                    const cleanAns = cols[1] ? cols[1].trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "";
                    const cleanUrl = cols[2] ? cols[2].trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "";

                    if (cleanKey && cleanAns) {
                        const keywords = cleanKey.split(/,| /).map(k => k.trim()).filter(k => k);
                        let finalAnswer = cleanAns;
                        if (cleanUrl) {
                            if (cleanUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) finalAnswer += `\n\n![Image](${cleanUrl})`;
                            else finalAnswer += `\n\n[‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°](${cleanUrl})`;
                        }
                        newKnowledge.push({ keywords: keywords, answer: finalAnswer });
                    }
                }
            });
            
            // ‚úÖ MERGE Strategy: ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö Static Data
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î) ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡πÉ‡∏ô Sheet ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ
            if (newKnowledge.length > 0) {
                knowledgeBase = [...newKnowledge, ...STATIC_DATA];
                console.log("Knowledge Base Merged: " + knowledgeBase.length + " items");
            }
        }

        // --- Main Logic ---
        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const message = inputField.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            inputField.value = '';
            
            // 1. ‡∏ñ‡∏≤‡∏° Google Sheet / Local Data ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)
            const sheetMatch = checkKnowledgeBase(message);
            if (sheetMatch) {
                setTimeout(() => addMessage(sheetMatch, 'bot'), 500);
                return;
            }

            // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏° n8n (AI)
            addMessage("... ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ...", 'bot', true); 

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); 

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`Status: ${response.status}`);

                const responseText = await response.text(); 
                
                if (!responseText || responseText.trim() === "") {
                     throw new Error("Empty Response");
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    if (responseText.includes("Workflow was started")) {
                        throw new Error("SettingError");
                    }
                    throw new Error("Invalid JSON");
                }
                
                let botReply = data.reply || data.output || data.text;

                if (!botReply) {
                     botReply = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏°‡∏≤ (No reply key)";
                }

                removeLoadingMessage();
                addMessage(botReply, 'bot');

            } catch (error) {
                console.error("n8n Error:", error);
                removeLoadingMessage();
                
                let friendlyError = "";
                if (error.message === "Empty Response") {
                    friendlyError = "‚ö†Ô∏è <b>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</b><br><small>(‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ: ‡πÑ‡∏õ‡∏ó‡∏µ‡πà n8n > ‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏õ‡∏´‡∏≤‡πÇ‡∏´‡∏ô‡∏î Respond to Webhook ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞)</small>";
                } else if (error.name === 'AbortError') {
                    friendlyError = "‚è≥ <b>‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤</b><br>‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤";
                } else if (error.message.includes("SettingError")) {
                    friendlyError = "üîß <b>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ n8n ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Ñ‡πà‡∏∞</b><br>‡πÑ‡∏õ‡∏ó‡∏µ‡πà n8n > ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å Webhook > ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Respond ‡πÄ‡∏õ‡πá‡∏ô <b>'Using Respond Node'</b> ‡∏ô‡∏∞‡∏Ñ‡∏∞";
                } else {
                    friendlyError = `üòø <b>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</b><br><small>(${error.message})</small>`;
                }

                addMessage(friendlyError, 'bot', false, 'error');
            }
        }

        function checkKnowledgeBase(query) {
            if (!isDbLoaded || knowledgeBase.length === 0) return null;
            const lowerQuery = query.toLowerCase();
            let bestMatch = null;
            let maxScore = 0;
            for (let item of knowledgeBase) {
                let score = 0;
                item.keywords.forEach(k => { if (lowerQuery.includes(k)) score += 10; });
                if (score > maxScore) { maxScore = score; bestMatch = item.answer; }
            }
            return maxScore > 0 ? bestMatch : null;
        }

        // --- UI Utils ---
        function addMessage(text, sender, isLoading = false, type = 'normal') {
            const chatBox = document.getElementById("chat-messages");
            const msgDiv = document.createElement("div");
            msgDiv.className = `msg ${sender} ${type}`;
            if (isLoading) msgDiv.id = "loadingMsg";
            
            let processedText = text.replace(/\\n/g, '\n'); 
            let formattedText = marked.parse(processedText);
            
            if (isLoading) {
               formattedText = `<div class="typing-container">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>`;
            }
            msgDiv.innerHTML = formattedText;
            chatBox.appendChild(msgDiv);
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 50);
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById("loadingMsg");
            if (loadingMsg) loadingMsg.remove();
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }
        function quickAsk(text) { 
            const input = document.getElementById("userInput");
            input.value = text;
            sendMessage();
        }
    </script>
</body>
</html>
