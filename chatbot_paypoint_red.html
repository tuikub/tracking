<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuiKub Ai Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Sarabun & Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0; padding: 0; 
            background-color: #f8fafc; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .chat-container {
            display: flex; flex-direction: column; height: 100%; 
            background: white;
            max-width: 100%;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        
        /* Theme: Calm Blue */
        .chat-header {
            background: linear-gradient(135deg, #2563eb, #0ea5e9); 
            color: white;
            padding: 14px 18px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-messages {
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background-color: #f1f5f9; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 14px;
            scroll-behavior: smooth;
        }

        .chat-input-area {
            padding: 16px; 
            border-top: 1px solid #e2e8f0; 
            background: white;
            display: flex; 
            gap: 10px; 
            position: relative;
            flex-shrink: 0;
            align-items: center;
        }

        .chat-input {
            flex: 1; 
            padding: 12px 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 30px;
            outline: none; 
            font-size: 0.95em; 
            transition: all 0.3s;
            background-color: #f8fafc;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .chat-input:focus { 
            border-color: #3b82f6; 
            background-color: white; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chat-send-btn {
            background: #2563eb; 
            color: white; 
            border: none; 
            width: 45px; 
            height: 45px;
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }
        .chat-send-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .chat-send-btn:active { transform: scale(0.95); }

        /* Message Bubbles */
        .msg { 
            max-width: 80%; 
            padding: 12px 16px; 
            border-radius: 18px; 
            font-size: 0.95em; 
            line-height: 1.6; 
            word-wrap: break-word; 
            position: relative;
            animation: fadeIn 0.3s ease-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .msg.bot { 
            background: white; 
            color: #334155; 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
            border: 1px solid #e2e8f0; 
        }
        .msg.user { 
            background: #2563eb; 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
        }
        .msg.error { border: 1px solid #fecaca; background: #fff1f2; color: #991b1b; }

        .msg img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Suggestions Chips */
        .suggestions { 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding: 12px 16px; 
            background: white; 
            border-bottom: 1px solid #f1f5f9; 
            white-space: nowrap;
            flex-shrink: 0;
            scrollbar-width: none; 
        }
        .suggestions::-webkit-scrollbar { display: none; }
        
        .chip {
            background: #eff6ff; 
            color: #1e40af; 
            padding: 8px 16px; 
            border-radius: 20px;
            font-size: 0.85em; 
            cursor: pointer; 
            border: 1px solid #dbeafe; 
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Prompt', sans-serif;
        }
        .chip:hover { 
            background: #2563eb; 
            color: white; 
            border-color: #2563eb; 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        /* Typing Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Status Dot */
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;
            position: absolute; bottom: 0; right: 0;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
        .bg-loading { background-color: #fbbf24; }
        .bg-online { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        
        /* Social Icons in Footer */
        .social-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
        }
        .social-link {
            color: #94a3b8;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .social-link:hover { color: #2563eb; transform: scale(1.1); }
        .social-link.youtube:hover { color: #ef4444; }
        .social-link.line:hover { color: #06c755; }
        .social-link.facebook:hover { color: #1877f2; }

    </style>
</head>
<body>

    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-inner relative">
                    <!-- Icon ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Headset ‡∏™‡∏≤‡∏ß‡πÜ -->
                    <i class="fa-solid fa-headset text-lg"></i>
                    <div id="db-status" class="status-dot bg-loading" title="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."></div>
                </div>
                <div>
                    <h3 class="font-bold text-base font-['Prompt'] tracking-wide">TuiKub Ai Assistant</h3>
                    <p class="text-[11px] opacity-80 font-light" id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <button onclick="window.parent.postMessage('closeChat', '*')" class="text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-full transition" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">
                <i class="fa-solid fa-chevron-down text-lg"></i>
            </button>
        </div>

        <!-- Suggestions -->
        <div class="suggestions" id="suggestion-box">
            <span class="chip" onclick="quickAsk('‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏±‡∏á‡πÑ‡∏á')"><i class="fa-solid fa-box-open mr-1"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏</span>
            <span class="chip" onclick="quickAsk('‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')"><i class="fa-solid fa-coins mr-1"></i> ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span>
            <span class="chip" onclick="quickAsk('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•')"><i class="fa-solid fa-map-location-dot mr-1"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•</span>
            <span class="chip" onclick="quickAsk('‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö')"><i class="fa-solid fa-headset mr-1"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</span>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages">
            <div class="msg bot">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! <b>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô TuiKub (‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö)</b> ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üë©‚Äçüíª<br>
                ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏ô‡∏™‡πà‡∏á, ‡∏û‡∏±‡∏™‡∏î‡∏∏, ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞!
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <input type="text" id="userInput" class="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡πà‡∏∞..." autocomplete="off" onkeypress="handleKeyPress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane text-sm"></i>
            </button>
        </div>
        
        <!-- Footer -->
        <div class="bg-white py-2 border-t border-slate-50">
            <div class="social-links mb-1">
                <a href="https://www.youtube.com/channel/UC0IEG_tOt1Hrj4FXDbkZN-A" target="_blank" class="social-link youtube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
                <a href="https://www.facebook.com/papacking" target="_blank" class="social-link facebook" title="Facebook"><i class="fa-brands fa-facebook"></i></a>
                <a href="https://lin.ee/khaW3QI" target="_blank" class="social-link line" title="Line"><i class="fa-brands fa-line"></i></a>
            </div>
            <div class="text-[10px] text-slate-400 text-center select-none font-['Prompt']">
                Powered by TuiKub Ai Assistant | Created by @pratya chatyachatmontree
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SHEET_ID = '13YE50RWDXik5YhrIqB6naWRxfwDFtFVFbtqs-2bH0Hc'; 
        const N8N_WEBHOOK_URL = "https://n8n.srv1265116.hstgr.cloud/webhook/chat"; 

        // --- HARDCODED KNOWLEDGE BASE (Female Tone) ---
        const STATIC_DATA = [
            { keywords: ["‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", "‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏∏‡πâ‡∏¢‡∏Ñ‡∏•‡∏±‡∏ö"], answer: "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (TuiKub) ‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞:\n\n‚Ä¢ Line: [‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏≠‡∏î‡πÑ‡∏•‡∏ô‡πå](https://lin.ee/khaW3QI)\n‚Ä¢ Facebook: [PaPacking](https://www.facebook.com/papacking)\n‚Ä¢ YouTube: [TuiKub Channel](https://www.youtube.com/channel/UC0IEG_tOt1Hrj4FXDbkZN-A)", url: "https://lin.ee/khaW3QI" },
            { keywords: ["‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡πÑ‡∏´‡∏ô", "‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"], answer: "‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞" },
            { keywords: ["‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô", "‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠", "‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"], answer: "‡∏ñ‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏∞" },
            { keywords: ["‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç"], answer: "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞" },
            { keywords: ["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡πÑ‡∏Å‡∏•", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏≤‡∏∞"], answer: "‚Ä¢ ‡πÑ‡∏°‡πà‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°: KEX (Kerry) ‚úÖ\n\n‚Ä¢ ‡∏ö‡∏ß‡∏Å 20 ‡∏ö‡∏≤‡∏ó: Post Sabuy\n\n‚Ä¢ ‡∏ö‡∏ß‡∏Å 50 ‡∏ö‡∏≤‡∏ó: Flash, J&T, Best , DHL ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏∞", url: "https://tuikub.github.io/tracking/remote.html" },
            { keywords: ["‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå", "paypoint", "‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô"], answer: "‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÇ‡∏ó‡∏£.099-1209227 (‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏∏‡πä‡∏Å‡∏Å‡∏µ‡πâ)", url: "https://tuikub.github.io/tracking/franchise.html" },
            { keywords: ["‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ", "‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏î‡∏µ‡∏Ñ‡πà‡∏∞"], answer: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô TuiKub ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?" },
            { keywords: ["‡πÉ‡∏Ñ‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤", "pratya"], answer: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì **Pratya Chatyachatmontree** ‡∏Ñ‡πà‡∏∞ üòé" }
        ];

        let knowledgeBase = [...STATIC_DATA]; 
        let isDbLoaded = true; 

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchSheetData(); 
        });

        // --- Fetch Data ---
        async function fetchSheetData() {
            const statusDot = document.getElementById('db-status');
            const statusText = document.getElementById('status-text');
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const csvText = await response.text();
                parseCSV(csvText); 
                statusDot.className = "status-dot bg-online";
                statusDot.title = "Online";
                statusText.innerText = "Online";
            } catch (error) {
                console.warn("Using Local Backup Data:", error);
                statusDot.className = "status-dot bg-loading"; 
                statusDot.title = "Offline Mode";
                statusText.innerText = "Offline Mode";
            }
        }

        // --- CSV Parser ---
        function parseCSV(text) {
            const newKnowledge = []; 
            const rows = text.split('\n');
            rows.forEach((row, index) => {
                if (!row.trim()) return;
                const cols = [];
                let current = '';
                let inQuote = false;
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { cols.push(current); current = ''; } 
                    else current += char;
                }
                cols.push(current);
                if (cols.length >= 2) {
                    const cleanKey = cols[0] ? cols[0].trim().replace(/^"|"$/g, '').replace(/""/g, '"').toLowerCase() : "";
                    const cleanAns = cols[1] ? cols[1].trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "";
                    const cleanUrl = cols[2] ? cols[2].trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "";
                    if (cleanKey && cleanAns) {
                        const keywords = cleanKey.split(/,| /).map(k => k.trim()).filter(k => k);
                        let finalAnswer = cleanAns;
                        if (cleanUrl) {
                            if (cleanUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) finalAnswer += `\n\n![Image](${cleanUrl})`;
                            else finalAnswer += `\n\n[‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°](${cleanUrl})`;
                        }
                        newKnowledge.push({ keywords: keywords, answer: finalAnswer });
                    }
                }
            });
            if (newKnowledge.length > 0) knowledgeBase = newKnowledge; 
        }

        // --- Core Functions ---
        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const message = inputField.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            inputField.value = '';
            
            // 1. Check Knowledge Base
            const sheetMatch = checkKnowledgeBase(message);
            if (sheetMatch) {
                setTimeout(() => addMessage(sheetMatch, 'bot'), 500);
                return;
            }

            // 2. Fallback to n8n AI
            addMessage("... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ...", 'bot', true); 

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á AbortController ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Timeout (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏≠‡πÄ‡∏Å‡πâ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); 

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`Status: ${response.status}`);

                const responseText = await response.text(); 
                
                // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ Error: Empty Response ---
                if (!responseText || responseText.trim() === "") {
                     // ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ n8n ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö
                     throw new Error("Empty Response");
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("n8n Raw Response:", responseText);
                    if (responseText.includes("Workflow was started")) {
                        throw new Error("SettingError: ‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Webhook Respond ‡πÄ‡∏õ‡πá‡∏ô 'Using Respond Node'");
                    }
                    throw new Error(`ParseError: "${responseText.substring(0, 50)}..."`);
                }
                
                let botReply = data.reply || data.output || data.text;

                if (!botReply) {
                     // ‡πÑ‡∏î‡πâ JSON ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ key ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                     botReply = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (No reply key)";
                }

                removeLoadingMessage();
                addMessage(botReply, 'bot');

            } catch (error) {
                console.error("n8n Error:", error);
                removeLoadingMessage();
                
                // ‡πÅ‡∏õ‡∏•‡∏á Error ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
                let friendlyError = "";
                if (error.message === "Empty Response") {
                    friendlyError = "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (Empty Response)<br><br><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà n8n:</b><br>1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡πÇ‡∏´‡∏ô‡∏î <b>Respond to Webhook</b> ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?<br>2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Workflow ‡πÑ‡∏°‡πà Error ‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏≤‡∏á";
                } else if (error.name === 'AbortError') {
                    friendlyError = "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout) ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞";
                } else if (error.message.includes("SettingError")) {
                    friendlyError = "‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ n8n ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Webhook Respond ‡πÄ‡∏õ‡πá‡∏ô <b>'Using Respond Node'</b>";
                } else {
                    friendlyError = `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (${error.message})`;
                }

                addMessage(friendlyError, 'bot', false, 'error');
            }
        }

        function checkKnowledgeBase(query) {
            if (!isDbLoaded || knowledgeBase.length === 0) return null;
            const lowerQuery = query.toLowerCase();
            let bestMatch = null;
            let maxScore = 0;
            for (let item of knowledgeBase) {
                let score = 0;
                item.keywords.forEach(k => { if (lowerQuery.includes(k)) score += 10; });
                if (score > maxScore) { maxScore = score; bestMatch = item.answer; }
            }
            return maxScore > 0 ? bestMatch : null;
        }

        // --- UI Helpers ---
        function addMessage(text, sender, isLoading = false, type = 'normal') {
            const chatBox = document.getElementById("chat-messages");
            const msgDiv = document.createElement("div");
            msgDiv.className = `msg ${sender} ${type}`;
            if (isLoading) msgDiv.id = "loadingMsg";
            
            let processedText = text.replace(/\\n/g, '\n'); 
            let formattedText = marked.parse(processedText);
            
            if (isLoading) {
               formattedText = `<div class="flex items-center space-x-1 h-4">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                </div>`;
            }
            msgDiv.innerHTML = formattedText;
            chatBox.appendChild(msgDiv);
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 50);
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById("loadingMsg");
            if (loadingMsg) loadingMsg.remove();
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }
        function quickAsk(text) { 
            const input = document.getElementById("userInput");
            input.value = text;
            sendMessage();
        }
    </script>
</body>
</html>
