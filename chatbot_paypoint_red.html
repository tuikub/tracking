 <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot PAYPOINT Tracking</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        /* Main Fonts */
        .font-sans { font-family: 'Sarabun', sans-serif; }
        .font-header { font-family: 'Prompt', sans-serif; }

        /* Widget Container */
        #chatbot-widget-container { 
            font-family: 'Sarabun', sans-serif; 
            z-index: 99999; 
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
        }

        /* Prevent Text Selection in Header */
        #chat-window header {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Hide Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        .chat-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-hidden { opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; visibility: hidden; }
        .chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; visibility: visible; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Typing Dots Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Watermark */
        .chat-watermark {
            font-size: 10px;
            color: #94a3b8;
            text-align: center;
            margin-top: 6px;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center">

    <!-- Demo Background Content (Optional) -->
    <div class="text-center text-gray-400 p-4">
        <h1 class="text-2xl font-bold font-header mb-2">PAYPOINT</h1>
        <p>The chatbot by pratya chartmontree.</p>
    </div>

    <!-- WIDGET START -->
    <div id="chatbot-widget-container">
        
        <!-- Chat Window -->
        <div id="chat-window" class="chat-hidden chat-transition bg-white w-[350px] h-[520px] max-h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
            
            <!-- Header (Theme: Paypoint Red) -->
            <div class="bg-gradient-to-r from-red-600 to-orange-500 p-4 flex items-center justify-between text-white shadow-md z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white font-bold relative border border-white/30">
                        <i class="fa-solid fa-headset text-lg"></i>
                        <!-- Online Status Dot -->
                        <div id="status-dot" class="absolute bottom-0 right-0 w-3 h-3 bg-gray-400 border-2 border-white rounded-full" title="Connecting..."></div>
                    </div>
                    <div>
                        <h1 class="font-header font-bold text-lg leading-tight">Logistics Support</h1>
                        <p id="model-status" class="text-[11px] text-orange-100 opacity-90">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
                    </div>
                </div>
                <!-- Controls -->
                <div class="flex gap-1">
                    <button onclick="toggleSettings()" class="text-white/70 hover:text-white p-2 rounded-full transition" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">
                        <i class="fa-solid fa-sliders text-xs"></i>
                    </button>
                    <button onclick="toggleChat()" class="text-white/80 hover:text-white p-2 rounded-full transition">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scrollbar-hide text-sm relative">
                <!-- Welcome Message -->
                <div class="flex items-start gap-2 animate-fade-in">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-xs font-bold shrink-0 shadow-sm">AI</div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-800 leading-relaxed">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üôè<br>
                        ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden px-4 pb-2">
                <div class="flex items-center space-x-1 bg-white px-3 py-2 rounded-xl w-fit shadow-sm border border-gray-100">
                    <div class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-gray-100">
                <form id="chat-form" class="flex gap-2 items-center relative">
                    <input type="text" id="user-input" 
                        class="flex-1 bg-gray-100 border-0 text-gray-900 text-sm rounded-full focus:ring-2 focus:ring-red-500 block w-full px-4 py-3 outline-none transition placeholder-gray-400" 
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡∏ö..." autocomplete="off">
                    <button type="submit" 
                        class="bg-red-600 hover:bg-red-700 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </form>
                <div class="chat-watermark">PAYPOINT Logistics Support AI</div>
            </div>

            <!-- Settings Panel -->
            <div id="settings-panel" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-50 flex flex-col p-6 animate-fade-in font-sans">
                <h3 class="font-header font-bold text-gray-700 mb-6 flex items-center gap-2 text-lg">
                    <i class="fa-solid fa-gear text-red-500"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                </h3>
                
                <div class="space-y-4 flex-1 overflow-y-auto">
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Google Sheet ID</label>
                        <input type="text" id="sheet-id-input" class="w-full border rounded-lg p-2 text-xs mt-1 bg-gray-50 focus:ring-1 focus:ring-red-500 outline-none placeholder-gray-300" placeholder="e.g., 1-G8YWdp...">
                    </div>
                    <hr class="border-gray-100">
                    <div>
                        <label class="text-xs font-semibold text-blue-600 uppercase">Primary: Gemini API Key</label>
                        <input type="password" id="gemini-key-input" class="w-full border border-blue-100 rounded-lg p-2 text-xs mt-1 focus:ring-1 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-purple-600 uppercase">Fallback: Together.ai Key</label>
                        <input type="password" id="together-key-input" class="w-full border border-purple-100 rounded-lg p-2 text-xs mt-1 focus:ring-1 focus:ring-purple-500 outline-none">
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                         <p class="text-[10px] text-yellow-700"><i class="fa-solid fa-circle-info mr-1"></i> Keys are saved in your browser's local storage.</p>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="toggleSettings()" class="flex-1 py-2.5 text-gray-600 text-sm hover:bg-gray-100 rounded-lg transition font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveSettings()" class="flex-1 py-2.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 shadow-md transition font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()" id="chat-toggle-btn" 
            class="bg-gradient-to-br from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 group relative z-50 ring-4 ring-white/30">
            <i class="fa-solid fa-comment-dots text-3xl absolute transition-all duration-300 transform group-hover:rotate-12 scale-100 opacity-100" id="icon-closed"></i>
            <i class="fa-solid fa-chevron-down text-2xl absolute transition-all duration-300 transform rotate-180 scale-0 opacity-0" id="icon-opened"></i>
            
            <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-4 w-4">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-4 w-4 bg-orange-500 border-2 border-white"></span>
            </span>
        </button>
    </div>

    <!-- Script -->
    <script>
        // --- Configuration ---
        // Defaults (can be overridden in UI)
        let sheetId = localStorage.getItem('chat_sheet_id') || '1-G8YWdpXq8YsXNNK9d5vhUcVrEOlCvKucHrd5Bmimcc';
        let geminiKey = localStorage.getItem('chat_gemini_key') || 'AIzaSyCBr6LjhCCkJVwkAJTqEIMuIekkjl3X6r4';
        
        let togetherKey = localStorage.getItem('chat_together_key') || 'f1ab2db1ed0da368ff5d3001a70855fac21f2b161a12021e44c1e3e75f05e575'; 
        
        // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        const ADMIN_PASSWORD = "02817648+++"; 

        // Knowledge Base Storage
        let KNOWLEDGE_BASE = "";
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const sheetInput = document.getElementById('sheet-id-input');
            const geminiInput = document.getElementById('gemini-key-input');
            const togetherInput = document.getElementById('together-key-input');
            
            if(sheetInput) sheetInput.value = sheetId;
            if(geminiInput) geminiInput.value = geminiKey;
            if(togetherInput) togetherInput.value = togetherKey;

            if(sheetId) fetchSheetData();
        });

        // --- Fetch Knowledge Base (Google CSV) ---
        async function fetchSheetData() {
            try {
                // Fetch as CSV
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    if (response.status === 404) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Sheet ID ‡∏ô‡∏µ‡πâ");
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Share: Anyone with link)");
                }
                
                const csvText = await response.text();
                parseCSVtoKnowledge(csvText);
                
                // Status Update: Green
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full";
                document.getElementById('status-dot').title = "Online: Knowledge Loaded";
                console.log("Knowledge Base Loaded Successfully");
            } catch (error) {
                console.error("Sheet Error:", error);
                // Status Update: Red
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full";
                document.getElementById('status-dot').title = "Error: Check Settings";
                addMessage('system', `‚ö†Ô∏è <strong>System Error:</strong> ${error.message}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤`);
            }
        }

        function parseCSVtoKnowledge(csv) {
            const rows = csv.split(/\r?\n/);
            let textData = "# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏ PAYPOINT (Knowledge Base)\n\n";
            let validCount = 0;
            
            console.group("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet (Rows A-B-C)");
            
            rows.forEach((row, index) => {
                if(index === 0) return; // Skip Header
                if(!row.trim()) return; // Skip empty rows

                // Robust CSV Parsing (Handle quotes and commas inside fields)
                let cols = [];
                let current = '';
                let inQuote = false;
                
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') {
                        if (inQuote && row[i+1] === '"') { // Handle escaped quotes ""
                            current += '"';
                            i++;
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (char === ',' && !inQuote) {
                        cols.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                cols.push(current.trim()); // Push last column

                // Map Columns: A=Question (0), B=Answer (1), C=URL (2)
                if(cols.length >= 2) {
                    const q = cols[0].replace(/^"|"$/g, '').trim(); 
                    const a = cols[1].replace(/^"|"$/g, '').trim();
                    // Fix: Explicitly check for column C
                    const url = cols[2] ? cols[2].replace(/^"|"$/g, '').trim() : '';
                    
                    if(q && a) {
                        textData += `--- ITEM ---\nQuestion (A): ${q}\nAnswer (B): ${a}\n${url ? 'URL (C): ' + url : ''}\n`;
                        validCount++;

                        // Debug: Show first 5 rows OR any row with URL to verify C column
                        if (index <= 5 || url) {
                            console.log(`Row ${index}:`, {
                                'A (‡∏ñ‡∏≤‡∏°)': q,
                                'B (‡∏ï‡∏≠‡∏ö)': a,
                                'C (URL)': url || '(‡πÑ‡∏°‡πà‡∏°‡∏µ)'
                            });
                        }
                    }
                }
            });
            
            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            console.groupEnd();
            
            KNOWLEDGE_BASE = textData;
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)
            // addMessage('system', `‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }

        // --- AI Logic (Gemini -> Fallback Together) ---
        async function getAIResponse(userMessage) {
            if (!geminiKey && !togetherKey) return "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key (Gemini ‡∏´‡∏£‡∏∑‡∏≠ Together AI) ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞";

            // 1. Try Gemini
            if (geminiKey) {
                document.getElementById('model-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå... (Gemini)";
                try {
                    return await callGemini(userMessage);
                } catch (error) {
                    console.warn("Gemini Error, Switching to Fallback...", error);
                    if (!togetherKey) {
                        document.getElementById('model-status').innerText = "Gemini Error";
                        return `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö Gemini ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á (${error.message || 'Unknown'})`;
                    }
                }
            }

            // 2. Fallback to Together AI
            if (togetherKey) {
                document.getElementById('model-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå... (Backup AI)";
                try {
                    return await callTogetherAI(userMessage);
                } catch (error) {
                    console.error("Together AI Error:", error);
                    document.getElementById('model-status').innerText = "System Error";
                    return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞";
                }
            }
            
            return "‡πÑ‡∏°‡πà‡∏û‡∏ö API Key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞";
        }

        async function callGemini(message) {
            // Using Gemini 1.5 Flash (Efficient for chat)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`;
            
            const prompt = `
            Context Data (Knowledge Base from Google Sheet):
            ${KNOWLEDGE_BASE}
            
            System Instructions:
            You are "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" (Logistics Support AI).
            Your duty is to answer questions based ONLY on the "Context Data".
            
            Context Awareness & Persona:
            1. IF the user asks about: "‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏°", "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô", "‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡∏¥‡∏î", "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", "Flash Home", "J&T Home", "‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å" (Branch/Franchise issues):
               - Tone: Concise, direct, technical.
               - Focus: Troubleshooting and technical steps.
            2. IF the user asks about: "‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ñ‡∏∂‡∏á‡πÑ‡∏´‡∏ô", "‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", "‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡∏Å", "‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "COD", "‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ñ‡∏∂‡∏á" (General Customer):
               - Tone: Polite, soft, service-minded, avoid technical jargon.
            
            Strict Rules:
            1. NO Hallucinations: Answer ONLY based on the Context Data.
            2. Unknown Information: If the answer is not in the Context Data, reply EXACTLY: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"
            3. **MANDATORY**: If the Context Data for the answer contains a 'URL (C)', you MUST append it at the end of the response. Do NOT forget the link.
            4. Formatting: Use numbered lists (1, 2, 3) for steps.
            5. Language: Thai only.
            
            User Question: ${message}
            `;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates || data.candidates.length === 0) throw new Error("No response generated");
            
            document.getElementById('model-status').innerText = "‡∏ï‡∏≠‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ô‡πâ‡∏≠‡∏á AI";
            return data.candidates[0].content.parts[0].text;
        }

        async function callTogetherAI(message) {
            const url = "https://api.together.xyz/v1/chat/completions";
            
            // Optimized System Prompt for Llama 3.2 3B Instruct Turbo
            // Tactic: Force strict retrieval, punish hallucination, ensure URL presence.
            const promptSystem = `
            You are a helpful assistant for PAYPOINT. 
            Your goal is to answer the user's question using ONLY the provided Context Data.
            
            Context Data:
            ${KNOWLEDGE_BASE}
            
            Instructions:
            1. Search the "Context Data" for a "Question (A)" that has the same meaning as the User's Question.
            2. If found, reply exactly with the corresponding "Answer (B)".
            3. If the answer contains a "URL (C)", append it to the end.
            4. If the answer is NOT in the context, reply: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"
            5. Do NOT make up answers. Do NOT assume. Use ONLY the text provided.
            
            Language: Thai
            `;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${togetherKey}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: "meta-llama/Llama-3.2-3B-Instruct-Turbo",
                    messages: [
                        { role: "system", content: promptSystem },
                        { role: "user", content: message }
                    ],
                    max_tokens: 512,
                    temperature: 0.1, // LOW temperature to force strict adherence to context
                    top_p: 0.8,
                    top_k: 40,
                    repetition_penalty: 1.1 // Prevents loops
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            document.getElementById('model-status').innerText = "‡∏ï‡∏≠‡∏ö‡πÇ‡∏î‡∏¢ Backup AI";
            return data.choices[0].message.content;
        }

        // --- UI Functions ---
        const chatWindow = document.getElementById('chat-window');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const loading = document.getElementById('loading');
        const settingsPanel = document.getElementById('settings-panel');
        const iconClosed = document.getElementById('icon-closed');
        const iconOpened = document.getElementById('icon-opened');

        function toggleChat() {
            const isHidden = chatWindow.classList.contains('chat-hidden');
            if (isHidden) {
                chatWindow.classList.remove('chat-hidden');
                chatWindow.classList.add('chat-visible');
                iconClosed.classList.add('scale-0', 'opacity-0');
                iconOpened.classList.remove('scale-0', 'opacity-0', 'rotate-180');
                setTimeout(() => userInput.focus(), 100);
            } else {
                chatWindow.classList.add('chat-hidden');
                chatWindow.classList.remove('chat-visible');
                iconClosed.classList.remove('scale-0', 'opacity-0');
                iconOpened.classList.add('scale-0', 'opacity-0', 'rotate-180');
            }
        }

        function toggleSettings() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (settingsPanel.classList.contains('hidden')) {
                // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà -> ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™)
                const password = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:", "");
                
                if (password === ADMIN_PASSWORD) {
                    settingsPanel.classList.remove('hidden');
                } else if (password !== null) { // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î Cancel ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡∏ú‡∏¥‡∏î
                    alert("‚õî ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ");
                }
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà -> ‡∏à‡∏∞‡∏õ‡∏¥‡∏î (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™)
                settingsPanel.classList.add('hidden');
            }
        }

        function saveSettings() {
            const newSheetId = document.getElementById('sheet-id-input').value.trim();
            const newGeminiKey = document.getElementById('gemini-key-input').value.trim();
            const newTogetherKey = document.getElementById('together-key-input').value.trim();

            if(newSheetId) {
                sheetId = newSheetId;
                localStorage.setItem('chat_sheet_id', sheetId);
            }
            // Allow clearing keys by saving empty
            geminiKey = newGeminiKey;
            localStorage.setItem('chat_gemini_key', geminiKey);
            
            togetherKey = newTogetherKey;
            localStorage.setItem('chat_together_key', togetherKey);

            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            settingsPanel.classList.add('hidden');
            addMessage('system', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞...');
            fetchSheetData();
        }

        function addMessage(role, text) {
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex items-start gap-2 ${isUser ? 'flex-row-reverse' : ''} animate-fade-in`;
            
            const avatar = isUser ? '' : 
                `<div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-[10px] font-bold shrink-0 shadow-sm">AI</div>`;

            const bubbleColor = isUser ? 'bg-red-600 text-white' : 'bg-white text-gray-800 border border-gray-100';
            const systemStyle = role === 'system' ? 'bg-yellow-50 text-yellow-700 border-yellow-100 text-xs w-full text-center' : '';

            // Auto-link detection
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const textWithLinks = text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" class="underline decoration-dotted ${isUser ? 'text-white' : 'text-blue-600'} hover:opacity-80 break-all">${url}</a>`;
            });

            div.innerHTML = `
                ${role === 'system' ? '' : avatar}
                <div class="max-w-[85%] p-3 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm text-sm leading-relaxed break-words ${role === 'system' ? systemStyle : bubbleColor}">
                    ${textWithLinks}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Event Listeners ---
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            // UI Updates
            addMessage('user', text);
            userInput.value = '';
            loading.classList.remove('hidden');
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Disable input while thinking
            userInput.disabled = true;
            document.querySelector('#chat-form button').disabled = true;

            try {
                const reply = await getAIResponse(text);
                addMessage('ai', reply);
            } catch (err) {
                addMessage('system', 'Error getting response');
            } finally {
                loading.classList.add('hidden');
                userInput.disabled = false;
                document.querySelector('#chat-form button').disabled = false;
                userInput.focus();
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
    </script>
</body>
</html>
